{% extends "dashboard_base.html" %}

{% block title %}修改密码{% endblock %}
{% block page_title %}修改密码{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6 mx-auto">
        <div class="content-card">
            <div class="content-header">
                <h5><i class="fas fa-key text-primary"></i> 修改管理员密码</h5>
            </div>
            <div class="content-body">
                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label">当前密码</label>
                        <input type="password" name="current_password" class="form-control" placeholder="请输入当前密码" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">新密码</label>
                        <input type="password" name="new_password" class="form-control" placeholder="请输入新密码" minlength="6" required>
                        <div class="form-text">密码长度至少6位，建议包含字母和数字</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">确认新密码</label>
                        <input type="password" name="confirm_password" class="form-control" placeholder="请再次输入新密码" minlength="6" required>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                            <i class="fas fa-arrow-left"></i> 返回
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 修改密码
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 数据备份管理 -->
        <div class="content-card mt-4">
            <div class="content-header">
                <h6><i class="fas fa-database text-primary"></i> 数据备份管理</h6>
            </div>
            <div class="content-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-success w-100" onclick="createBackup()">
                            <i class="fas fa-download"></i> 创建备份
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-info w-100" onclick="showBackupList()">
                            <i class="fas fa-list"></i> 备份列表
                        </button>
                    </div>
                </div>
                
                <!-- 备份列表区域 -->
                <div id="backupListArea" style="display: none;" class="mt-3">
                    <div class="border rounded p-3">
                        <h6 class="mb-3">备份文件列表</h6>
                        <div id="backupList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> 加载中...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 恢复数据区域 -->
                <div class="mt-3">
                    <label class="form-label">恢复数据</label>
                    <div class="input-group">
                        <input type="file" class="form-control" id="restoreFile" accept=".zip">
                        <button type="button" class="btn btn-warning" onclick="restoreData()">
                            <i class="fas fa-upload"></i> 恢复
                        </button>
                    </div>
                    <div class="form-text">选择备份文件进行数据恢复</div>
                </div>
            </div>
        </div>
        
        <!-- 安全提示 -->
        <div class="content-card mt-4">
            <div class="content-header">
                <h6><i class="fas fa-shield-alt text-warning"></i> 安全提示</h6>
            </div>
            <div class="content-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        请定期修改管理员密码以确保系统安全
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        建议定期备份数据，避免数据丢失
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        恢复数据前会自动创建当前数据的备份
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 创建备份
function createBackup() {
    showMessage('正在创建备份...', 'info');
    
    fetch('/admin/backup', {
        method: 'POST',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('备份创建成功！', 'success');
            if (document.getElementById('backupListArea').style.display !== 'none') {
                loadBackupList();
            }
        } else {
            showMessage('备份创建失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Backup error:', error);
        showMessage('备份创建失败: 网络错误', 'danger');
    });
}

// 显示备份列表
function showBackupList() {
    const area = document.getElementById('backupListArea');
    if (area.style.display === 'none') {
        area.style.display = 'block';
        loadBackupList();
    } else {
        area.style.display = 'none';
    }
}

// 加载备份列表
function loadBackupList() {
    const listDiv = document.getElementById('backupList');
    listDiv.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';

    fetch('/admin/backups')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.backups.length === 0) {
                listDiv.innerHTML = '<div class="text-center text-muted">暂无备份文件</div>';
            } else {
                let html = '';
                data.backups.forEach(backup => {
                    html += `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>${backup.filename}</strong><br>
                                <small class="text-muted">${backup.created_at}</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="downloadBackup('${backup.filename}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteBackup('${backup.filename}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                listDiv.innerHTML = html;
            }
        } else {
            listDiv.innerHTML = '<div class="text-center text-danger">加载失败</div>';
        }
    })
    .catch(error => {
        console.error('Load backup list error:', error);
        listDiv.innerHTML = '<div class="text-center text-danger">加载失败</div>';
    });
}

// 下载备份
function downloadBackup(filename) {
    window.open(`/admin/backup/download/${filename}`, '_blank');
}

// 删除备份
function deleteBackup(filename) {
    if (confirm(`确定要删除备份文件 ${filename} 吗？`)) {
        fetch(`/admin/backup/delete/${filename}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('备份文件删除成功', 'success');
                loadBackupList();
            } else {
                showMessage('删除失败: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Delete backup error:', error);
            showMessage('删除失败: 网络错误', 'danger');
        });
    }
}

// 恢复数据
function restoreData() {
    const fileInput = document.getElementById('restoreFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showMessage('请选择要恢复的备份文件', 'warning');
        return;
    }
    
    if (!confirm('确定要恢复数据吗？当前数据将被覆盖！')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('backup_file', file);
    
    showMessage('正在恢复数据...', 'info');

    fetch('/admin/backup/restore', {
        method: 'POST',
        credentials: 'same-origin',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message || '数据恢复成功！', 'success');
            fileInput.value = '';

            // 如果需要重启服务
            if (data.restart_required) {
                setTimeout(() => {
                    showMessage('⚠️ 请重启服务以完成恢复过程！数据库结构需要重新初始化。', 'warning');
                }, 2000);
            }
        } else {
            showMessage('恢复失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Restore error:', error);
        showMessage('恢复失败: 网络错误', 'danger');
    });
}

// 消息显示函数
function showMessage(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const content = document.querySelector('.dashboard-content');
    content.insertBefore(alertDiv, content.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('修改密码页面加载完成');

    // 密码确认验证
    const newPasswordInput = document.querySelector('input[name="new_password"]');
    const confirmPasswordInput = document.querySelector('input[name="confirm_password"]');

    function checkPasswordMatch() {
        if (newPasswordInput.value && confirmPasswordInput.value) {
            if (newPasswordInput.value !== confirmPasswordInput.value) {
                confirmPasswordInput.setCustomValidity('密码不匹配');
            } else {
                confirmPasswordInput.setCustomValidity('');
            }
        }
    }

    if (newPasswordInput && confirmPasswordInput) {
        newPasswordInput.addEventListener('input', checkPasswordMatch);
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    }

    // 表单提交验证
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const currentPassword = document.querySelector('input[name="current_password"]').value;
            const newPassword = document.querySelector('input[name="new_password"]').value;
            const confirmPassword = document.querySelector('input[name="confirm_password"]').value;

            if (!currentPassword) {
                e.preventDefault();
                showMessage('请输入当前密码', 'warning');
                return;
            }

            if (!newPassword || newPassword.length < 6) {
                e.preventDefault();
                showMessage('新密码长度至少6位', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                e.preventDefault();
                showMessage('两次输入的密码不一致', 'warning');
                return;
            }

            // 显示加载状态
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 修改中...';
        });
    }
});
</script>
{% endblock %}
