{% extends "dashboard_base.html" %}

{% block title %}账号管理{% endblock %}
{% block page_title %}账号管理{% endblock %}

{% block extra_css %}
<style>
    .copy-item {
        position: relative;
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        max-width: 200px;
    }
    .copy-item:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .copy-item.password {
        color: #0d6efd;
        border-color: #b6d7ff;
        background: #f0f8ff;
    }
    .copy-item.password:hover {
        background: #e6f3ff;
        border-color: #0d6efd;
    }

    .copy-item .copy-icon {
        margin-left: 8px;
        opacity: 0.6;
        font-size: 0.75rem;
        transition: opacity 0.2s ease;
    }
    .copy-item:hover .copy-icon {
        opacity: 1;
    }
    .copy-item .text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }
    .notes-container .notes-display {
        min-height: 20px;
        display: block;
        padding: 2px 4px;
        border: 1px solid transparent;
        border-radius: 3px;
        cursor: pointer;
    }
    .notes-container .notes-display:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    .batch-operations {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- 账号统计卡片 -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">总账号数</p>
                    <h4 class="stats-number">{{ accounts|length }}</h4>
                </div>
                <div class="text-primary">
                    <i class="fas fa-users fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">活跃账号</p>
                    <h4 class="stats-number text-success">{{ accounts|selectattr('is_active')|list|length }}</h4>
                </div>
                <div class="text-success">
                    <i class="fas fa-check-circle fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">今日新增</p>
                    <h4 class="stats-number text-info">0</h4>
                </div>
                <div class="text-info">
                    <i class="fas fa-user-plus fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="stats-label">即将到期</p>
                    <h4 class="stats-number text-warning">0</h4>
                </div>
                <div class="text-warning">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 主要内容卡片 -->
<div class="content-card">
    <div class="content-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-users text-primary"></i> 账号列表</h5>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-success btn-sm" onclick="exportAccounts()">
                    <i class="fas fa-download"></i> 导出账号
                </button>
                <button type="button" class="btn btn-info btn-sm" onclick="showImportModal()">
                    <i class="fas fa-upload"></i> 导入账号
                </button>
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    <i class="fas fa-plus"></i> 添加账号
                </button>
            </div>
        </div>
    </div>
    
    <div class="content-body">
        <!-- 批量操作区域 -->
        <div class="batch-operations" id="batchOperationArea" style="display: none;">
            <div class="d-flex align-items-center justify-content-between">
                <span class="text-muted">已选择 <strong id="selectedCount">0</strong> 个账号</span>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-warning btn-sm" onclick="batchRandomPassword()" title="为选中账号生成随机密码">
                        <i class="fas fa-dice"></i> 随机密码
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="batchDeleteAccounts()" title="删除选中的账号">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSelection()" title="清除所有选择">
                        <i class="fas fa-times"></i> 清除选择
                    </button>
                </div>
            </div>
        </div>

        <!-- 账号表格 -->
        {% if accounts %}
        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="3%">
                            <input type="checkbox" id="selectAll" class="form-check-input" title="全选/取消全选">
                        </th>
                        <th width="4%">序号</th>
                        <th width="12%">账号</th>
                        <th width="15%">密码</th>
                        <th width="12%">添加时间</th>
                        <th width="12%">VIP到期时间</th>
                        <th width="6%">卡密数量</th>
                        <th width="16%">备注</th>
                        <th width="8%">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input account-checkbox"
                                   value="{{ account.username | e }}"
                                   data-username="{{ account.username | e }}">
                        </td>
                        <td>{{ account.index }}</td>
                        <td>
                            <span class="text-primary" style="cursor: pointer; font-weight: 500;"
                                  onclick="showAccountCards('{{ account.username | e }}')"
                                  title="点击查看卡密信息">
                                {{ account.username }}
                            </span>
                        </td>
                        <td>
                            <div class="copy-item password"
                                 data-password="{{ account.password }}"
                                 title="点击复制密码">
                                <span class="text">{{ account.password }}</span>
                                <i class="fas fa-copy copy-icon"></i>
                            </div>
                        </td>
                        <td>
                            <small class="text-muted">{{ account.created_at }}</small>
                        </td>
                        <td>
                            <div class="vip-expiry-container" data-username="{{ account.username | e }}">
                                <span class="vip-expiry-display" onclick="editVipExpiry('{{ account.username | e }}')"
                                      title="点击修改VIP到期时间" style="cursor: pointer;">
                                    {% if account.vip_expiry and account.vip_expiry != '未设置' %}
                                        <small class="text-success">{{ account.vip_expiry }}</small>
                                    {% else %}
                                        <small class="text-muted">未设置</small>
                                    {% endif %}
                                </span>
                                <input type="datetime-local" class="form-control form-control-sm vip-expiry-input"
                                       style="display: none; font-size: 12px;"
                                       onblur="saveVipExpiry('{{ account.username | e }}')"
                                       onkeypress="handleVipExpiryKeypress(event, '{{ account.username | e }}')"
                                       title="设置VIP到期时间">
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ account.card_count }}</span>
                        </td>
                        <td>
                            <div class="notes-container" data-username="{{ account.username | e }}">
                                <span class="notes-display" onclick="editNotes('{{ account.username | e }}')"
                                      title="点击编辑备注">
                                    {{ account.notes or '点击添加备注...' }}
                                </span>
                                <input type="text" class="form-control form-control-sm notes-input"
                                       style="display: none;"
                                       value="{{ account.notes or '' }}"
                                       onblur="saveNotes('{{ account.username | e }}')"
                                       onkeypress="handleNotesKeypress(event, '{{ account.username | e }}')"
                                       maxlength="200"
                                       placeholder="输入备注信息...">
                            </div>
                        </td>
                        <td>
                            <span class="text-danger" style="cursor: pointer; text-decoration: underline;"
                                  onclick="deleteAccount('{{ account.username | e }}')"
                                  title="删除账号">
                                删除
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">暂无账号数据</h5>
            <p class="text-muted">点击上方"添加账号"按钮开始添加账号</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 添加账号模态框 -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加账号</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="addAccountForm">
                <div class="modal-body">
                    <input type="hidden" name="action" value="add">
                    <div class="mb-3">
                        <label class="form-label">账号名</label>
                        <div class="input-group">
                            <input type="text" name="new_account" class="form-control" id="newAccountInput" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="generateRandomAccount()">
                                <i class="fas fa-dice"></i> 随机
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">密码</label>
                        <div class="input-group">
                            <input type="text" name="password" class="form-control" id="newPasswordInput" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="generateRandomPassword()">
                                <i class="fas fa-dice"></i> 随机
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">VIP到期时间</label>
                        <input type="datetime-local" name="vip_expiry" class="form-control">
                        <div class="form-text">留空则默认30天后到期</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">添加账号</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 导入账号模态框 -->
<div class="modal fade" id="importAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">导入账号</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" enctype="multipart/form-data" id="importAccountForm" action="/admin/import_accounts">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">选择CSV文件</label>
                        <input type="file" name="import_file" class="form-control" accept=".csv" required>
                        <div class="form-text">
                            CSV格式：账号,密码,创建时间,VIP到期时间,状态,备注<br>
                            示例：test001,password123,2024-01-01 12:00:00,2024-02-01 12:00:00,正常,测试账号<br>
                            <small class="text-muted">注意：表头必须完全匹配，可以先导出一个样本文件作为模板</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-info" id="importSubmitBtn">导入账号</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 批量操作功能
function initializeBatchOperations() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const accountCheckboxes = document.querySelectorAll('.account-checkbox');
    const batchOperationArea = document.getElementById('batchOperationArea');
    const selectedCountSpan = document.getElementById('selectedCount');

    // 全选/取消全选
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            accountCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBatchOperationArea();
        });
    }

    // 单个复选框变化
    accountCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBatchOperationArea();

            // 更新全选状态
            const checkedCount = document.querySelectorAll('.account-checkbox:checked').length;
            const totalCount = accountCheckboxes.length;
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = checkedCount === totalCount;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
            }
        });
    });
}

function updateBatchOperationArea() {
    const checkedBoxes = document.querySelectorAll('.account-checkbox:checked');
    const batchOperationArea = document.getElementById('batchOperationArea');
    const selectedCountSpan = document.getElementById('selectedCount');

    if (selectedCountSpan) {
        selectedCountSpan.textContent = checkedBoxes.length;
    }

    if (batchOperationArea) {
        if (checkedBoxes.length > 0) {
            batchOperationArea.style.display = 'block';
        } else {
            batchOperationArea.style.display = 'none';
        }
    }
}

function clearSelection() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const accountCheckboxes = document.querySelectorAll('.account-checkbox');

    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    accountCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBatchOperationArea();
}

// 批量随机密码
function batchRandomPassword() {
    const checkedBoxes = document.querySelectorAll('.account-checkbox:checked');

    if (checkedBoxes.length === 0) {
        showMessage('请先选择要操作的账号', 'warning');
        return;
    }

    const usernames = Array.from(checkedBoxes).map(checkbox => checkbox.value);

    // 直接执行，不需要确认
    showMessage('正在生成随机密码...', 'info');

    // 发送请求
    fetch('/admin/batch_update_accounts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            usernames: usernames,
            operation: 'randomPassword'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            clearSelection();
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage('操作失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Batch random password error:', error);
        showMessage('操作失败: 网络错误', 'danger');
    });
}

// 批量删除账号
function batchDeleteAccounts() {
    const checkedBoxes = document.querySelectorAll('.account-checkbox:checked');

    if (checkedBoxes.length === 0) {
        showMessage('请先选择要删除的账号', 'warning');
        return;
    }

    const usernames = Array.from(checkedBoxes).map(checkbox => checkbox.value);

    // 单次确认操作（与单个删除一致）
    const confirmMessage = `确定要删除选中的 ${usernames.length} 个账号吗？这将同时删除所有相关卡密！`;
    if (!confirm(confirmMessage)) {
        return;
    }

    // 显示加载状态
    showMessage('正在删除账号...', 'info');

    // 发送请求
    fetch('/admin/batch_delete_accounts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            usernames: usernames
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            clearSelection();
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showMessage('删除失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Batch delete error:', error);
        showMessage('删除失败: 网络错误', 'danger');
    });
}

// 生成随机中文账号名
function generateRandomAccount() {
    const prefixes = [
        '风过', '月夜', '星辰', '云端', '雨落', '雪飞', '花开', '叶落', '山水', '江河',
        '天涯', '海角', '梦回', '醉卧', '独行', '踏雪', '寻梅', '听雨', '观云', '望月',
        '青山', '绿水', '红尘', '紫陌', '金风', '玉露', '银河', '碧海', '丹霞', '翠微',
        '春风', '夏雨', '秋月', '冬雪', '晨曦', '夕阳', '暮色', '黎明', '午后', '深夜'
    ];

    const suffixes = [
        '留香', '轻歌', '漫舞', '飞扬', '清风', '明月', '流水', '青山', '白云', '红叶',
        '如梦', '似幻', '若水', '如烟', '似火', '如冰', '若雪', '如玉', '似锦', '如诗',
        '逍遥', '自在', '无忧', '随心', '任性', '洒脱', '飘逸', '优雅', '从容', '淡然',
        '悠然', '安然', '怡然', '泰然', '超然', '释然', '坦然', '欣然', '欣喜', '欢愉'
    ];

    const randomPrefix = prefixes[Math.floor(Math.random() * prefixes.length)];
    const randomSuffix = suffixes[Math.floor(Math.random() * suffixes.length)];
    const accountName = randomPrefix + randomSuffix;

    document.getElementById('newAccountInput').value = accountName;
}

// 生成随机密码（参考批量随机密码格式）
function generateRandomPassword() {
    const digits = '23456789';
    const lowercase = 'abcdefhjkmnprstuvwxyz';
    const uppercase = 'ABCDEFHJKMNPRSTUVWXYZ';

    let password = '';
    password += digits[Math.floor(Math.random() * digits.length)];
    password += lowercase[Math.floor(Math.random() * lowercase.length)];
    password += uppercase[Math.floor(Math.random() * uppercase.length)];

    const allChars = digits + lowercase + uppercase;
    for (let i = 0; i < 9; i++) { // 总长度12位
        password += allChars[Math.floor(Math.random() * allChars.length)];
    }

    // 打乱顺序
    password = password.split('').sort(() => Math.random() - 0.5).join('');

    document.getElementById('newPasswordInput').value = password;
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('账号管理页面加载完成');
    initializeBatchOperations();

    // 初始化密码复制功能
    document.querySelectorAll('.copy-item.password').forEach(element => {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const password = this.getAttribute('data-password') || this.querySelector('.text').textContent.trim();
            copyToClipboard(password, '密码');
        });
    });

    // 自动生成随机账号名和密码
    generateRandomAccount();
    generateRandomPassword();
});

// 右侧弹出式消息显示函数
function showMessage(message, type = 'info') {
    // 创建消息容器（如果不存在）
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        `;
        document.body.appendChild(toastContainer);
    }

    // 创建toast元素
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : type === 'warning' ? 'warning' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    // 显示toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    bsToast.show();

    // 移除已隐藏的toast
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// 导出账号
function exportAccounts() {
    showMessage('正在导出账号数据...', 'info');

    fetch('/admin/export_accounts', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'accounts_data.csv';
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
            if (filenameMatch && filenameMatch[1]) {
                filename = filenameMatch[1].replace(/['"]/g, '');
            }
        }

        return response.blob().then(blob => ({ blob, filename }));
    })
    .then(({ blob, filename }) => {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        showMessage('账号数据导出成功！', 'success');
    })
    .catch(error => {
        console.error('Export error:', error);
        showMessage('导出失败：' + error.message, 'danger');
    });
}

function showImportModal() {
    const modal = new bootstrap.Modal(document.getElementById('importAccountModal'));
    modal.show();
}

// 处理导入表单提交
document.getElementById('importAccountForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('importSubmitBtn');
    const originalText = submitBtn.textContent;

    // 显示加载状态
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>导入中...';

    const formData = new FormData(this);

    fetch('/admin/import_accounts', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('网络请求失败');
        }
        return response.text();
    })
    .then(data => {
        // 导入成功，刷新页面
        showMessage('导入成功', 'success');
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Import error:', error);
        showMessage('导入失败：' + error.message, 'danger');
    })
    .finally(() => {
        // 恢复按钮状态
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});

function showAccountCards(username) {
    // 获取账号卡密信息并显示在模态框中
    fetch(`/admin/account_cards/${encodeURIComponent(username)}`, {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayAccountCardsModal(data);
        } else {
            showMessage('获取卡密信息失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Get account cards error:', error);
        showMessage('获取卡密信息失败: 网络错误', 'danger');
    });
}

function deleteAccount(username) {
    if (confirm(`确定要删除账号 ${username} 吗？这将同时删除所有相关卡密！`)) {
        fetch(`/admin/delete_account/${encodeURIComponent(username)}`, {
            method: 'POST',
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('账号删除成功', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showMessage('删除失败: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showMessage('删除失败: 网络错误', 'danger');
        });
    }
}

// 备注编辑功能
function editNotes(username) {
    const container = document.querySelector(`.notes-container[data-username="${username}"]`);
    const display = container.querySelector('.notes-display');
    const input = container.querySelector('.notes-input');

    display.style.display = 'none';
    input.style.display = 'block';
    input.focus();
    input.select();
}

function saveNotes(username) {
    const container = document.querySelector(`.notes-container[data-username="${username}"]`);
    const display = container.querySelector('.notes-display');
    const input = container.querySelector('.notes-input');
    const newNotes = input.value.trim();

    fetch('/admin/update_account_notes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            username: username,
            notes: newNotes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            display.textContent = newNotes || '点击添加备注...';
            display.style.color = newNotes ? '#000' : '#999';
            display.style.fontStyle = newNotes ? 'normal' : 'italic';

            input.style.display = 'none';
            display.style.display = 'block';

            if (newNotes) {
                showMessage('备注更新成功', 'success');
            }
        } else {
            showMessage('备注更新失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Update notes error:', error);
        showMessage('备注更新失败: 网络错误', 'danger');
    });
}

function handleNotesKeypress(event, username) {
    if (event.key === 'Enter') {
        event.preventDefault();
        saveNotes(username);
    } else if (event.key === 'Escape') {
        event.preventDefault();
        cancelNotesEdit(username);
    }
}

function cancelNotesEdit(username) {
    const container = document.querySelector(`.notes-container[data-username="${username}"]`);
    const display = container.querySelector('.notes-display');
    const input = container.querySelector('.notes-input');

    input.value = display.textContent === '点击添加备注...' ? '' : display.textContent;
    input.style.display = 'none';
    display.style.display = 'block';
}

// 编辑VIP到期时间
function editVipExpiry(username) {
    const container = document.querySelector(`.vip-expiry-container[data-username="${username}"]`);
    const display = container.querySelector('.vip-expiry-display');
    const input = container.querySelector('.vip-expiry-input');

    // 隐藏显示，显示输入框
    display.style.display = 'none';
    input.style.display = 'block';

    // 获取当前值并设置到输入框
    const currentText = display.textContent.trim();
    if (currentText !== '未设置') {
        // 尝试解析现有时间
        try {
            const dateMatch = currentText.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
            if (dateMatch) {
                const dateStr = dateMatch[1].replace(' ', 'T');
                input.value = dateStr;
            }
        } catch (e) {
            console.log('解析现有时间失败:', e);
        }
    }

    input.focus();
}

// 保存VIP到期时间
function saveVipExpiry(username) {
    const container = document.querySelector(`.vip-expiry-container[data-username="${username}"]`);
    const display = container.querySelector('.vip-expiry-display');
    const input = container.querySelector('.vip-expiry-input');

    const newValue = input.value;

    // 发送更新请求
    fetch('/admin/update_vip_expiry', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            username: username,
            vip_expiry: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新显示
            if (newValue) {
                const formattedDate = new Date(newValue).toLocaleString('zh-CN');
                display.innerHTML = `<small class="text-success">${formattedDate}</small>`;
            } else {
                display.innerHTML = '<small class="text-muted">未设置</small>';
            }
            showMessage('VIP到期时间更新成功', 'success');
        } else {
            showMessage('更新失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Update error:', error);
        showMessage('更新失败: 网络错误', 'danger');
    })
    .finally(() => {
        // 恢复显示状态
        input.style.display = 'none';
        display.style.display = 'block';
    });
}

// 处理VIP到期时间输入的回车键
function handleVipExpiryKeypress(event, username) {
    if (event.key === 'Enter') {
        saveVipExpiry(username);
    }
}

// 显示账号卡密信息模态框
function displayAccountCardsModal(data) {
    const modalId = 'accountCardsModal';

    // 如果模态框已存在，先移除
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }

    // 创建模态框HTML
    const modalHtml = `
        <div class="modal fade" id="${modalId}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-credit-card text-primary"></i>
                            账号 "${data.account_name}" 的卡密信息
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="badge bg-primary">总计: ${data.total_cards} 个卡密</span>
                        </div>
                        ${data.cards.length > 0 ? `
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="8%">序号</th>
                                            <th width="25%">卡密</th>
                                            <th width="12%">状态</th>
                                            <th width="15%">开始时间</th>
                                            <th width="15%">到期时间</th>
                                            <th width="10%">查询次数</th>
                                            <th width="15%">有效期</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.cards.map(card => `
                                            <tr>
                                                <td>${card.index}</td>
                                                <td>
                                                    <div class="copy-item password modal-card-copy" style="max-width: 180px;"
                                                         data-card-key="${card.card_key}"
                                                         title="点击复制卡密">
                                                        <span class="text">${card.card_key}</span>
                                                        <i class="fas fa-copy copy-icon"></i>
                                                    </div>
                                                    ${card.extracted ? '<span class="badge bg-success ms-2">已提取</span>' : ''}
                                                </td>
                                                <td>
                                                    <span class="badge bg-${card.status_class}">${card.status}</span>
                                                </td>
                                                <td><small>${card.start_time}</small></td>
                                                <td><small>${card.expiry_date}</small></td>
                                                <td>
                                                    <span class="badge bg-info">${card.query_count}/${card.max_query_count}</span>
                                                </td>
                                                <td><small>${card.duration_hours}小时</small></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">该账号暂无卡密</h6>
                                <p class="text-muted">可以通过批量生成功能为此账号生成卡密</p>
                            </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" onclick="goToBatchGenerate('${data.account_name}')">
                            <i class="fas fa-plus"></i> 生成卡密
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 添加模态框到页面
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    modal.show();

    // 绑定模态框中的复制事件
    setTimeout(() => {
        document.querySelectorAll('.modal-card-copy').forEach(element => {
            element.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const cardKey = this.getAttribute('data-card-key');
                copyToClipboard(cardKey, '卡密');
            });
        });
    }, 100);

    // 模态框关闭时移除DOM元素
    document.getElementById(modalId).addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// 复制到剪贴板
function copyToClipboard(text, type = '内容') {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            showMessage(`${type}已复制到剪贴板`, 'success');
        }).catch(() => {
            showMessage(`复制失败，请手动复制：${text}`, 'warning');
        });
    } else {
        // 兼容旧浏览器
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showMessage(`${type}已复制到剪贴板`, 'success');
        } catch (err) {
            showMessage(`复制失败，请手动复制：${text}`, 'warning');
        }
        document.body.removeChild(textArea);
    }
}

// 跳转到批量生成页面
function goToBatchGenerate(accountName) {
    window.location.href = `/admin/batch_generate?account=${encodeURIComponent(accountName)}`;
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('账号管理页面加载完成');
    initializeBatchOperations();
});
</script>
{% endblock %}
