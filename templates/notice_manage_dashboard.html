{% extends "dashboard_base.html" %}

{% block title %}公告管理{% endblock %}
{% block page_title %}公告管理{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="content-card">
            <div class="content-header">
                <h5><i class="fas fa-bullhorn text-primary"></i> 编辑公告内容</h5>
            </div>
            <div class="content-body">
                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label">主要说明内容</label>
                        <textarea name="content" class="form-control" rows="8" placeholder="请输入说明内容...">{{ content }}</textarea>
                        <div class="form-text">支持换行，将显示在查询页面的主要说明区域</div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">验证码提示</label>
                        <textarea name="captcha_notice" class="form-control" rows="3" placeholder="请输入验证码相关提示...">{{ captcha_notice }}</textarea>
                        <div class="form-text">显示在验证码按钮附近的提示信息</div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                            <i class="fas fa-arrow-left"></i> 返回
                        </button>
                        <button type="button" class="btn btn-info" onclick="previewNotice()">
                            <i class="fas fa-eye"></i> 预览效果
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 保存设置
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 预览区域 -->
        <div class="content-card mt-4" id="previewArea" style="display: none;">
            <div class="content-header">
                <h6><i class="fas fa-eye text-info"></i> 预览效果</h6>
            </div>
            <div class="content-body">
                <div class="border rounded p-3" style="background-color: #f8f9fa;">
                    <h6 class="text-primary mb-3">查询页面效果预览</h6>
                    
                    <!-- 主要说明区域 -->
                    <div class="alert alert-info" id="previewContent">
                        <!-- 内容将通过JavaScript填充 -->
                    </div>
                    
                    <!-- 验证码提示区域 -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-warning" disabled>
                            <i class="fas fa-eye"></i> 查看验证码
                        </button>
                        <small class="text-muted ms-2" id="previewCaptchaNotice">
                            <!-- 验证码提示将通过JavaScript填充 -->
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 使用说明 -->
        <div class="content-card mt-4">
            <div class="content-header">
                <h6><i class="fas fa-info-circle text-primary"></i> 使用说明</h6>
            </div>
            <div class="content-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        主要说明内容会显示在查询页面的顶部，用于向用户介绍使用方法
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        验证码提示会显示在"查看验证码"按钮附近，提醒用户注意事项
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        支持换行和基本的文本格式，建议保持简洁明了
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success me-2"></i>
                        修改后立即生效，用户刷新页面即可看到新内容
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 预览功能
function previewNotice() {
    const content = document.querySelector('textarea[name="content"]').value;
    const captchaNotice = document.querySelector('textarea[name="captcha_notice"]').value;
    
    // 显示预览区域
    const previewArea = document.getElementById('previewArea');
    previewArea.style.display = 'block';
    
    // 填充预览内容
    const previewContent = document.getElementById('previewContent');
    const previewCaptchaNotice = document.getElementById('previewCaptchaNotice');
    
    // 处理换行
    const formattedContent = content.replace(/\n/g, '<br>');
    const formattedCaptchaNotice = captchaNotice.replace(/\n/g, '<br>');
    
    previewContent.innerHTML = formattedContent || '<em class="text-muted">暂无内容</em>';
    previewCaptchaNotice.innerHTML = formattedCaptchaNotice || '<em class="text-muted">暂无提示</em>';
    
    // 滚动到预览区域
    previewArea.scrollIntoView({ behavior: 'smooth' });
}

// 实时预览（可选）
function enableLivePreview() {
    const contentTextarea = document.querySelector('textarea[name="content"]');
    const captchaTextarea = document.querySelector('textarea[name="captcha_notice"]');
    
    function updatePreview() {
        if (document.getElementById('previewArea').style.display !== 'none') {
            previewNotice();
        }
    }
    
    contentTextarea.addEventListener('input', updatePreview);
    captchaTextarea.addEventListener('input', updatePreview);
}

// 表单验证
function validateForm() {
    const content = document.querySelector('textarea[name="content"]').value.trim();
    const captchaNotice = document.querySelector('textarea[name="captcha_notice"]').value.trim();
    
    if (!content) {
        showMessage('主要说明内容不能为空', 'warning');
        return false;
    }
    
    if (!captchaNotice) {
        showMessage('验证码提示不能为空', 'warning');
        return false;
    }
    
    return true;
}

// 消息显示函数
function showMessage(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const content = document.querySelector('.dashboard-content');
    content.insertBefore(alertDiv, content.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('公告管理页面加载完成');
    
    // 启用实时预览
    enableLivePreview();
    
    // 表单提交验证
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
            }
        });
    }
    
    // 自动调整文本框高度
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
});
</script>
{% endblock %}
